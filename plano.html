<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>TOTEM Engineering Designer V7</title>

<!-- LIBRERAS -->
<script src="https://cdn.jsdelivr.net/npm/konva@9/konva.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>
<script async src="https://maps.googleapis.com/maps/api/js?key=TU_API_KEY"></script>

<style>
body{margin:0;font-family:system-ui;background:#e5e7eb;}
.container{display:flex;height:100vh;}

.toolbox{
width:260px;background:white;padding:15px;
border-right:1px solid #d1d5db;overflow:auto;
}
.toolbox h3{color:#1e3a8a;margin-top:10px;}
.toolbox button{
width:100%;padding:8px;margin-bottom:5px;
border-radius:6px;border:1px solid #d1d5db;
background:#f3f4f6;cursor:pointer;
}

.canvas-area{flex:1;position:relative;}
#container{width:100%;height:100%;background:#f9fafb;}
#map{position:absolute;inset:0;display:none;}

.zoom-control{
position:absolute;top:10px;left:10px;
background:white;padding:6px;border-radius:6px;
border:1px solid #d1d5db;
}

.summary{
position:absolute;bottom:60px;right:10px;
background:white;padding:10px;border-radius:8px;
border:1px solid #d1d5db;font-size:13px;
}

.legend{
position:absolute;bottom:0;left:0;right:0;
background:white;padding:8px;border-top:1px solid #ccc;
display:flex;gap:20px;justify-content:center;
font-size:12px;
}
.legend span{display:flex;align-items:center;gap:5px;}

.properties{
width:280px;background:white;padding:15px;
border-left:1px solid #d1d5db;overflow:auto;
}
.properties input{width:100%;margin-bottom:6px;}
</style>
</head>

<body>

<div class="container">

<!-- TOOLBOX -->
<div class="toolbox">

<h3>Plano</h3>
<button onclick="uploadPDF()">Cargar PDF</button>
<button onclick="uploadImage()">Cargar Imagen</button>
<button onclick="activateMap()">Google Maps</button>

<h3>CCTV</h3>
<button onclick="addCamera('bala')">Bala</button>
<button onclick="addCamera('domo')">Domo</button>
<button onclick="addCamera('ptz')">PTZ</button>
<button onclick="addCamera('lpr')">LPR</button>

<h3>Intrusi贸n</h3>
<button onclick="addPIR()">PIR</button>
<button onclick="addContact()">Contacto</button>
<button onclick="addPanel()">Panel</button>

<h3>Acceso</h3>
<button onclick="addReader()">Lectora</button>
<button onclick="addBarrier()">Barrera</button>

<h3>Detecci贸n</h3>
<button onclick="addSmoke()">Humo</button>
<button onclick="addSiren()">Sirena</button>
<button onclick="addFACP()">FACP</button>

</div>

<!-- CANVAS -->
<div class="canvas-area">

<div class="zoom-control">
Zoom:
<input type="range" min="0.5" max="2" step="0.1" value="1" onchange="setZoom(this.value)">
</div>

<div id="map"></div>
<div id="container"></div>

<div class="summary" id="summaryBox"></div>

<div class="legend" id="legendBox"></div>

<input type="file" id="pdfLoader" hidden>
<input type="file" id="imageLoader" hidden>

</div>

<!-- PROPIEDADES -->
<div class="properties">
<h3>Propiedades</h3>
<label>ID</label>
<input type="text" id="propID">
<label>ngulo</label>
<input type="number" id="propAngle">
<label>Distancia</label>
<input type="number" id="propRange">
<label>Color</label>
<input type="color" id="propColor">
<button onclick="updateProperties()">Actualizar</button>
</div>

</div>

<script>

/* ================= PDF WORKER ================= */
pdfjsLib.GlobalWorkerOptions.workerSrc =
'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js';

/* ================= STAGE ================= */
let stage=new Konva.Stage({
container:'container',
width:window.innerWidth-540,
height:window.innerHeight
});

let backgroundLayer=new Konva.Layer();
let elementLayer=new Konva.Layer();
stage.add(backgroundLayer);
stage.add(elementLayer);

let transformer=new Konva.Transformer({
rotateEnabled:true,
centeredScaling:true
});
elementLayer.add(transformer);

let selected=null;
let counts={cctv:0,intrusion:0,access:0,detect:0};

/* ================= CONFIG CCTV ================= */
const cameraTypes={
bala:{color:"#f59e0b",angle:60,range:120},
domo:{color:"#10b981",angle:75,range:100},
ptz:{color:"#ef4444",angle:90,range:150},
lpr:{color:"#3b82f6",angle:40,range:180}
};

/* ================= SELECCIN ================= */
stage.on('click',function(e){
if(e.target===stage){
transformer.nodes([]);
selected=null;
return;
}
selected=e.target.getParent();
transformer.nodes([selected]);
});

/* ================= CCTV ================= */
function addCamera(type){
let config=cameraTypes[type];
counts.cctv++;

let group=new Konva.Group({x:300,y:250,draggable:true});

let wedge=new Konva.Wedge({
x:0,y:0,
radius:config.range,
angle:config.angle,
fill:hexToRGBA(config.color,0.35),
stroke:config.color,
strokeWidth:2,
rotation:-config.angle/2
});

let cam=new Konva.Circle({
x:0,y:0,
radius:8,
fill:config.color,
stroke:"#111",
strokeWidth:1
});

group.add(wedge);
group.add(cam);

elementLayer.add(group);
elementLayer.draw();
updateSummary();
}

/* ================= INTRUSIN ================= */
function addPIR(){
counts.intrusion++;
let g=new Konva.Circle({x:200,y:200,radius:8,fill:"#34d399",draggable:true});
elementLayer.add(g);elementLayer.draw();updateSummary();
}
function addContact(){
counts.intrusion++;
let g=new Konva.Rect({x:220,y:200,width:20,height:6,fill:"#3b82f6",draggable:true});
elementLayer.add(g);elementLayer.draw();updateSummary();
}
function addPanel(){
counts.intrusion++;
let g=new Konva.Rect({x:240,y:200,width:30,height:30,fill:"#111827",draggable:true});
elementLayer.add(g);elementLayer.draw();updateSummary();
}

/* ================= ACCESO ================= */
function addReader(){
counts.access++;
let g=new Konva.Rect({x:200,y:250,width:15,height:30,fill:"#8b5cf6",draggable:true});
elementLayer.add(g);elementLayer.draw();updateSummary();
}
function addBarrier(){
counts.access++;
let g=new Konva.Rect({x:220,y:250,width:50,height:6,fill:"#f97316",draggable:true});
elementLayer.add(g);elementLayer.draw();updateSummary();
}

/* ================= DETECCIN ================= */
function addSmoke(){
counts.detect++;
let g=new Konva.Circle({x:200,y:300,radius:10,stroke:"#000",strokeWidth:2,draggable:true});
elementLayer.add(g);elementLayer.draw();updateSummary();
}
function addSiren(){
counts.detect++;
let g=new Konva.Circle({x:230,y:300,radius:10,fill:"#ef4444",draggable:true});
elementLayer.add(g);elementLayer.draw();updateSummary();
}
function addFACP(){
counts.detect++;
let g=new Konva.Rect({x:260,y:300,width:40,height:30,fill:"#dc2626",draggable:true});
elementLayer.add(g);elementLayer.draw();updateSummary();
}

/* ================= RESUMEN + LEYENDA ================= */
function updateSummary(){
document.getElementById("summaryBox").innerHTML=
"CCTV: "+counts.cctv+
"<br>Intrusi贸n: "+counts.intrusion+
"<br>Acceso: "+counts.access+
"<br>Detecci贸n: "+counts.detect+
"<br><b>Total: "+(counts.cctv+counts.intrusion+counts.access+counts.detect)+"</b>";

document.getElementById("legendBox").innerHTML=
"<span> CCTV: "+counts.cctv+"</span>"+
"<span> Intrusi贸n: "+counts.intrusion+"</span>"+
"<span> Acceso: "+counts.access+"</span>"+
"<span> Detecci贸n: "+counts.detect+"</span>";
}

/* ================= PDF ================= */
function uploadPDF(){
document.getElementById("pdfLoader").click();
}
document.getElementById("pdfLoader").addEventListener("change",async function(e){
let file=e.target.files[0];
let reader=new FileReader();
reader.onload=async function(){
let typedarray=new Uint8Array(this.result);
let pdf=await pdfjsLib.getDocument(typedarray).promise;
let page=await pdf.getPage(1);
let viewport=page.getViewport({scale:1.5});
let canvasPDF=document.createElement("canvas");
let context=canvasPDF.getContext("2d");
canvasPDF.width=viewport.width;
canvasPDF.height=viewport.height;
await page.render({canvasContext:context,viewport:viewport}).promise;
let img=new Image();
img.onload=function(){
backgroundLayer.destroyChildren();
backgroundLayer.add(new Konva.Image({
image:img,
width:stage.width(),
height:stage.height()
}));
backgroundLayer.draw();
}
img.src=canvasPDF.toDataURL();
};
reader.readAsArrayBuffer(file);
});

/* ================= IMAGEN ================= */
function uploadImage(){
document.getElementById("imageLoader").click();
}
document.getElementById("imageLoader").addEventListener("change",function(e){
let reader=new FileReader();
reader.onload=function(evt){
let img=new Image();
img.onload=function(){
backgroundLayer.destroyChildren();
backgroundLayer.add(new Konva.Image({
image:img,
width:stage.width(),
height:stage.height()
}));
backgroundLayer.draw();
}
img.src=evt.target.result;
};
reader.readAsDataURL(e.target.files[0]);
});

/* ================= GOOGLE MAPS ================= */
function activateMap(){
document.getElementById("map").style.display="block";
navigator.geolocation.getCurrentPosition(pos=>{
new google.maps.Map(document.getElementById("map"),{
center:{lat:pos.coords.latitude,lng:pos.coords.longitude},
zoom:19,
mapTypeId:'satellite'
});
});
}

/* ================= ZOOM ================= */
function setZoom(value){
stage.scale({x:value,y:value});
stage.draw();
}

/* ================= UTIL ================= */
function hexToRGBA(hex,a){
let r=parseInt(hex.slice(1,3),16);
let g=parseInt(hex.slice(3,5),16);
let b=parseInt(hex.slice(5,7),16);
return "rgba("+r+","+g+","+b+","+a+")";
}

</script>

</body>
</html>